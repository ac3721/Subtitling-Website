<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subtitle Editor with Video + Timestamp + Audio Visualization</title>

<style>
    body {
        margin: 0;
        background: #1c1c1c;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    /* LEFT PANEL — Subtitles */
    #subtitlePanel {
        width: 30%;
        background: #111;
        padding: 15px;
        overflow-y: auto;
        border-right: 2px solid #333;
    }

    h2 {
        margin-top: 0;
    }

    .subtitle-entry {
        padding: 10px;
        margin-bottom: 10px;
        background: #222;
        border-radius: 4px;
        border-left: 4px solid #368B9E;
    }

    .subtitle-entry input {
        width: 100%;
        background: #111;
        color: #fff;
        border: none;
        padding: 5px;
        margin-top: 5px;
    }

    /* RIGHT SIDE — Video + Canvas */
    #main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    #topSection {
        height: 70%;
        display: flex;
        flex-direction: column;
        padding: 10px;
    }

    video {
        width: 100%;
        height: auto;
        border-radius: 6px;
    }

    #visualizer {
        width: 100%;
        height: 140px;
        background: #222;
        margin-top: 10px;
    }

    #bottomHUD {
        padding: 10px;
        background: #111;
        border-top: 2px solid #333;
    }
</style>
</head>
<body>

<!-- LEFT: SUBTITLE LIST -->
<div id="subtitlePanel">
    <h2>Subtitles</h2>
    <div id="subtitleList"></div>
</div>

<!-- RIGHT: VIDEO & VISUALIZER -->
<div id="main">

    <div id="topSection">
        <input type="file" id="videoUpload" accept="video/*">
        <video id="video" controls></video>
        <canvas id="visualizer"></canvas>
    </div>

    <div id="bottomHUD">
        <p><b>Shortcuts:</b>  
        <br>Space = Play/Pause  
        <br><b>S</b> = Capture timestamp as start of next subtitle  
        <br><b>Enter</b> = End previous subtitle & create new one  
        </p>
        <p id="status">Status: Waiting…</p>
    </div>

</div>

<script>
/* --------------------------
   VIDEO UPLOAD
-------------------------- */
const video = document.getElementById("video");
document.getElementById("videoUpload").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    video.src = URL.createObjectURL(file);
});

/* --------------------------
   SUBTITLE MANAGEMENT
-------------------------- */
let subtitles = [];
let currentSubtitle = null;

const subtitleListDiv = document.getElementById("subtitleList");
const status = document.getElementById("status");

function addSubtitle(startTime) {
    // Close previous subtitle
    if (currentSubtitle) {
        currentSubtitle.end = startTime;
    }

    // Create new subtitle
    const newSub = {
        start: startTime,
        end: null,
        text: ""
    };
    subtitles.push(newSub);
    currentSubtitle = newSub;

    renderSubtitles();
}

function renderSubtitles() {
    subtitleListDiv.innerHTML = "";
    subtitles.forEach((sub, i) => {
        const div = document.createElement("div");
        div.className = "subtitle-entry";

        div.innerHTML = `
            <div><b>${formatTime(sub.start)}</b> → <b>${sub.end ? formatTime(sub.end) : "..."}</b></div>
            <input type="text" value="${sub.text}" placeholder="Type subtitle here..."
            oninput="subtitles[${i}].text = this.value">
        `;

        subtitleListDiv.appendChild(div);
    });
}

function formatTime(t) {
    const sec = t % 60;
    const min = Math.floor(t / 60);
    return `${String(min).padStart(2, "0")}:${String(sec.toFixed(3)).padStart(6, "0")}`;
}

/* --------------------------
   KEYBOARD SHORTCUTS
-------------------------- */
document.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
        e.preventDefault();
        video.paused ? video.play() : video.pause();
    }

    // S → Capture timestamp as new subtitle start
    if (e.key === "s" || e.key === "S") {
        e.preventDefault();
        video.pause();
        const t = video.currentTime;
        addSubtitle(t);
        status.textContent = `New subtitle started at ${t.toFixed(3)}s`;
    }

    // Enter → Close previous & begin next using prior end
    if (e.key === "Enter") {
        e.preventDefault();
        const t = video.currentTime;
        addSubtitle(t);
        status.textContent = `Previous ended & new subtitle began at ${t.toFixed(3)}s`;
    }
});

/* --------------------------
   AUDIO VISUALIZATION
-------------------------- */
const canvas = document.getElementById("visualizer");
const ctx = canvas.getContext("2d");

let audioCtx, analyser, sourceNode, dataArray;

function setupAudio() {
    if (audioCtx) return;

    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    const bufferLen = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLen);

    sourceNode = audioCtx.createMediaElementSource(video);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);

    drawVisualizer();
}

function drawVisualizer() {
    requestAnimationFrame(drawVisualizer);

    analyser.getByteFrequencyData(dataArray);

    ctx.fillStyle = "#111";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const barWidth = canvas.width / dataArray.length;

    for (let i = 0; i < dataArray.length; i++) {
        const h = dataArray[i];
        ctx.fillStyle = `rgb(${h + 50}, 80, 120)`;
        ctx.fillRect(i * barWidth, canvas.height - h, barWidth, h);
    }
}

video.addEventListener("play", setupAudio);

// Resize canvas with window
window.addEventListener("resize", () => {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
});
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;
</script>

</body>
</html>
